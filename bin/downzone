#!/bin/bash

# ===========================================
# Downzone - Dual License
# Copyright (c) 2025 Mohammad Reza Pegah
# ===========================================

# ===================== DEFAULT CONFIG =====================
DEFAULT_TIMEZONE="Asia/Tehran"
DEFAULT_START_TIME="02:30"
DEFAULT_END_TIME="06:30"
DEFAULT_DOWNLOAD_DIR="$HOME/Downloads"

MAX_RETRIES=3
CONNECT_TIMEOUT=20
MAX_TIME=0
# =========================================================

# ---------- Color codes ----------
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
RESET="\033[0m"

info()    { echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1${RESET}"; }
success() { echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS: $1${RESET}"; }
warning() { echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: $1${RESET}"; }
error()   { echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1${RESET}" >&2; }

# ---------- Timezone selection ----------
TIMEZONES=(
  "Asia/Tehran"
  "Europe/London"
  "Europe/Berlin"
  "Europe/Istanbul"
  "Asia/Dubai"
  "Asia/Tokyo"
  "America/New_York"
  "America/Los_Angeles"
)

while true; do
  echo "Select Timezone:"
  for i in "${!TIMEZONES[@]}"; do
    printf "%2d) %s\n" "$((i+1))" "${TIMEZONES[$i]}"
  done

  read -rp "Enter timezone number [default: Asia/Tehran]: " TZ_CHOICE

  if [[ -z "$TZ_CHOICE" ]]; then
    TIMEZONE="$DEFAULT_TIMEZONE"
    break
  elif [[ "$TZ_CHOICE" =~ ^[0-9]+$ ]] && (( TZ_CHOICE >= 1 && TZ_CHOICE <= ${#TIMEZONES[@]} )); then
    TIMEZONE="${TIMEZONES[$((TZ_CHOICE-1))]}"
    break
  else
    error "Invalid timezone selection"
  fi
done

export TZ="$TIMEZONE"
info "Timezone set to $TIMEZONE"

# ---------- Download directory selection ----------
while true; do
    read -rp "Enter download directory [default: $DEFAULT_DOWNLOAD_DIR]: " DOWNLOAD_DIR
    DOWNLOAD_DIR="${DOWNLOAD_DIR:-$DEFAULT_DOWNLOAD_DIR}"
    DOWNLOAD_DIR="${DOWNLOAD_DIR/#\~/$HOME}"

    if [ ! -d "$DOWNLOAD_DIR" ]; then
        warning "Directory does not exist. Create it? (y/n): "
        read -r CREATE_DIR
        if [[ "$CREATE_DIR" =~ ^[Yy]$ ]]; then
            mkdir -p "$DOWNLOAD_DIR" || { error "Failed to create directory"; continue; }
        else
            continue
        fi
    fi

    if [ ! -w "$DOWNLOAD_DIR" ]; then
        error "Directory is not writable: $DOWNLOAD_DIR"
        continue
    fi

    break
done

info "Download directory set to: $DOWNLOAD_DIR"

# ---------- Ask for links file ----------
while true; do
    read -rp "Enter full path to links file: " LINKS_FILE
    LINKS_FILE="${LINKS_FILE/#\~/$HOME}"

    if [ -f "$LINKS_FILE" ]; then
        info "Using links file: $LINKS_FILE"
        break
    else
        error "Links file not found: $LINKS_FILE"
    fi
done

# ---------- Ask for start & end time ----------
TIME_REGEX='^([01]?[0-9]|2[0-3]):[0-5][0-9]$'

while true; do
    read -rp "Enter START time (HH:MM) [default: $DEFAULT_START_TIME]: " START_TIME
    START_TIME=${START_TIME:-$DEFAULT_START_TIME}
    [[ "$START_TIME" =~ $TIME_REGEX ]] && break
    error "Invalid START time format"
done

while true; do
    read -rp "Enter END time   (HH:MM) [default: $DEFAULT_END_TIME]: " END_TIME
    END_TIME=${END_TIME:-$DEFAULT_END_TIME}
    [[ "$END_TIME" =~ $TIME_REGEX ]] && break
    error "Invalid END time format"
done

info "Download window: $START_TIME â†’ $END_TIME ($TIMEZONE)"

# ---------- Time calculation (macOS compatible) ----------
now_ts=$(date +%s)
start_ts=$(date -j -f "%H:%M" "$START_TIME" "+%s")
end_ts=$(date -j -f "%H:%M" "$END_TIME" "+%s")

if [ "$start_ts" -le "$now_ts" ]; then
  start_ts=$(date -j -v+1d -f "%H:%M" "$START_TIME" "+%s")
  end_ts=$(date -j -v+1d -f "%H:%M" "$END_TIME" "+%s")
fi

sleep_seconds=$((start_ts - now_ts))

info "Script started"
info "Waiting until $START_TIME..."
sleep "$sleep_seconds"

info "Download window opened"
cd "$DOWNLOAD_DIR" || { error "Cannot access $DOWNLOAD_DIR"; exit 1; }

# ---------- Download loop ----------
while IFS= read -r url || [ -n "$url" ]; do

  [[ -z "$url" ]] && continue
  [[ "$url" =~ ^[[:space:]]*# ]] && continue

  current_ts=$(date +%s)
  if [ "$current_ts" -ge "$end_ts" ]; then
    warning "End time reached. Stopping downloads."
    break
  fi

  filename=$(basename "${url%%\?*}")
  info "Starting download: $filename"

  attempt=1
  success_flag=false

  while [ "$attempt" -le "$MAX_RETRIES" ]; do
    info "Attempt $attempt of $MAX_RETRIES"

    curl -L \
         -C - \
         --progress-bar \
         --fail \
         --connect-timeout "$CONNECT_TIMEOUT" \
         --max-time "$MAX_TIME" \
         -O "$url"

    if [ $? -eq 0 ]; then
      success "Download completed: $filename"
      success "Saved to: $DOWNLOAD_DIR/$filename"
      success_flag=true
      break
    else
      error "Download failed for $filename"
      attempt=$((attempt + 1))
      sleep 3
    fi
  done

  [ "$success_flag" = false ] && warning "Skipping $filename"

done < "$LINKS_FILE"

success "Download session finished"
