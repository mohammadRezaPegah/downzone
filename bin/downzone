#!/bin/bash

# ===========================================
# Downzone - Dual License
# Copyright (c) 2025 Mohammad Reza Pegah
# ===========================================

# ===================== DEFAULT CONFIG =====================
DEFAULT_TIMEZONE="Asia/Tehran"
DEFAULT_START_TIME="02:30"
DEFAULT_END_TIME="06:30"
DEFAULT_DOWNLOAD_DIR="$HOME/Downloads"

MAX_RETRIES=3
CONNECT_TIMEOUT=20
MAX_TIME=0
# =========================================================

# ---------- Color codes ----------
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
BLUE="\033[34m"
RESET="\033[0m"

info()    { echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1${RESET}"; }
success() { echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')] SUCCESS: $1${RESET}"; }
warning() { echo -e "${YELLOW}[$(date '+%Y-%m-%d %H:%M:%S')] WARNING: $1${RESET}"; }
error()   { echo -e "${RED}[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1${RESET}" >&2; }

# ---------- Banner ----------
print_banner() {
echo -e "${GREEN}"
cat << "EOF"

██████╗  ██████╗ ██╗    ██╗███╗   ██╗    ███████╗ ██████╗ ███╗   ██╗███████╗
██╔══██╗██╔═══██╗██║    ██║████╗  ██║    ╚══███╔╝██╔═══██╗████╗  ██║██╔════╝
██║  ██║██║   ██║██║ █╗ ██║██╔██╗ ██║      ███╔╝ ██║   ██║██╔██╗ ██║█████╗  
██║  ██║██║   ██║██║███╗██║██║╚██╗██║     ███╔╝  ██║   ██║██║╚██╗██║██╔══╝  
██████╔╝╚██████╔╝╚███╔███╔╝██║ ╚████║    ███████╗╚██████╔╝██║ ╚████║███████╗
╚═════╝  ╚═════╝  ╚══╝╚══╝ ╚═╝  ╚═══╝    ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝╚══════╝

Version 1.0.0
Downzone - Dual License
Copyright (c) 2025 Mohammad Reza Pegah

EOF
echo -e "${RESET}"
}

clear
print_banner

# ---------- Prevent system sleep ----------
PREVENT_SLEEP_PID=""

start_prevent_sleep() {
    if command -v caffeinate >/dev/null 2>&1; then
        info "Preventing system sleep (macOS)"
        caffeinate -dims &
        PREVENT_SLEEP_PID=$!
    elif command -v systemd-inhibit >/dev/null 2>&1; then
        info "Preventing system sleep (Linux)"
        systemd-inhibit --what=sleep --why="Downzone downloads" bash -c "sleep infinity" &
        PREVENT_SLEEP_PID=$!
    else
        warning "Sleep prevention not supported on this system"
    fi
}

stop_prevent_sleep() {
    if [ -n "$PREVENT_SLEEP_PID" ]; then
        kill "$PREVENT_SLEEP_PID" >/dev/null 2>&1
        success "System sleep restored"
    fi
}

trap stop_prevent_sleep EXIT INT TERM

# ---------- Timezone selection ----------
TIMEZONES=(
  "Asia/Tehran"
  "Europe/London"
  "Europe/Berlin"
  "Europe/Istanbul"
  "Asia/Dubai"
  "Asia/Tokyo"
  "America/New_York"
  "America/Los_Angeles"
)

while true; do
  echo "Select Timezone:"
  for i in "${!TIMEZONES[@]}"; do
    printf "%2d) %s\n" "$((i+1))" "${TIMEZONES[$i]}"
  done

  read -rp "Enter timezone number [default: Asia/Tehran]: " TZ_CHOICE

  if [[ -z "$TZ_CHOICE" ]]; then
    TIMEZONE="$DEFAULT_TIMEZONE"
    break
  elif [[ "$TZ_CHOICE" =~ ^[0-9]+$ ]] && (( TZ_CHOICE >= 1 && TZ_CHOICE <= ${#TIMEZONES[@]} )); then
    TIMEZONE="${TIMEZONES[$((TZ_CHOICE-1))]}"
    break
  else
    error "Invalid timezone selection"
  fi
done

export TZ="$TIMEZONE"
info "Timezone set to $TIMEZONE"

# ---------- Download directory ----------
while true; do
    read -rp "Enter download directory [default: $DEFAULT_DOWNLOAD_DIR]: " DOWNLOAD_DIR
    DOWNLOAD_DIR="${DOWNLOAD_DIR:-$DEFAULT_DOWNLOAD_DIR}"
    DOWNLOAD_DIR="${DOWNLOAD_DIR/#\~/$HOME}"

    if [ ! -d "$DOWNLOAD_DIR" ]; then
        read -rp "Directory does not exist. Create it? (y/n): " CREATE
        [[ "$CREATE" =~ ^[Yy]$ ]] && mkdir -p "$DOWNLOAD_DIR" || continue
    fi

    [ -w "$DOWNLOAD_DIR" ] && break
    error "Directory is not writable"
done

info "Download directory set to: $DOWNLOAD_DIR"

# ---------- Links file ----------
while true; do
    read -rp "Enter full path to links file: " LINKS_FILE
    LINKS_FILE="${LINKS_FILE/#\~/$HOME}"
    [ -f "$LINKS_FILE" ] && break
    error "Links file not found"
done

# ---------- Time input ----------
TIME_REGEX='^([01]?[0-9]|2[0-3]):[0-5][0-9]$'

while true; do
    read -rp "Enter START time (HH:MM) [default: $DEFAULT_START_TIME]: " START_TIME
    START_TIME=${START_TIME:-$DEFAULT_START_TIME}
    [[ "$START_TIME" =~ $TIME_REGEX ]] && break
    error "Invalid START time format"
done

while true; do
    read -rp "Enter END time (HH:MM) [default: $DEFAULT_END_TIME]: " END_TIME
    END_TIME=${END_TIME:-$DEFAULT_END_TIME}
    [[ "$END_TIME" =~ $TIME_REGEX ]] && break
    error "Invalid END time format"
done

info "Download window: $START_TIME → $END_TIME ($TIMEZONE)"

# ---------- Time calculation ----------
now_ts=$(date +%s)

if date -j >/dev/null 2>&1; then
    start_ts=$(date -j -f "%H:%M" "$START_TIME" "+%s")
    end_ts=$(date -j -f "%H:%M" "$END_TIME" "+%s")
else
    start_ts=$(date -d "$START_TIME" +%s)
    end_ts=$(date -d "$END_TIME" +%s)
fi

[ "$start_ts" -le "$now_ts" ] && {
    start_ts=$((start_ts + 86400))
    end_ts=$((end_ts + 86400))
}

sleep_seconds=$((start_ts - now_ts))

info "Waiting until $START_TIME..."
start_prevent_sleep
sleep "$sleep_seconds"

info "Download window opened"
cd "$DOWNLOAD_DIR" || exit 1

# ---------- Download loop ----------
while IFS= read -r url || [ -n "$url" ]; do
    [[ -z "$url" || "$url" =~ ^[[:space:]]*# ]] && continue
    [ "$(date +%s)" -ge "$end_ts" ] && break

    filename=$(basename "${url%%\?*}")
    info "Downloading: $filename"

    attempt=1
    while [ "$attempt" -le "$MAX_RETRIES" ]; do
        curl -L -C - --progress-bar --fail \
             --connect-timeout "$CONNECT_TIMEOUT" \
             --max-time "$MAX_TIME" \
             -O "$url" && {
             success "Downloaded: $filename"
             success "Saved to: $DOWNLOAD_DIR/$filename"
             break
        }

        warning "Retry $attempt failed"
        attempt=$((attempt + 1))
        sleep 3
    done
done < "$LINKS_FILE"

success "Download session finished"
